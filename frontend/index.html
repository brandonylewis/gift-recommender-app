<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiftAI - Premium Recommendations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Maps API -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAwuNdT9j9hz0ymSyVRo9ySZTZGnhBw03g&libraries=places"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- AFFILIATE LOGIC ---
        const affiliateLinks = {
            'amazon': { tag: 'giftai-20' },
            'target': { tag: 'giftai' },
            'walmart': { tag: 'giftai' }
        };

        const getAffiliateLink = (url) => {
            if (!url) return '#';
            try {
                const domain = new URL(url).hostname;
                if (domain.includes('amazon')) return `${url}&tag=${affiliateLinks.amazon.tag}`;
                if (domain.includes('target')) return `${url}&aflt=${affiliateLinks.target.tag}`;
                return url;
            } catch (e) { return url; }
        };

        // --- MAPS COMPONENT ---
        const DistanceBadge = ({ retailer, location }) => {
            const [dist, setDist] = useState(null);

            useEffect(() => {
                if (!location || !retailer || !window.google) return;

                const service = new google.maps.places.PlacesService(document.createElement('div'));
                const request = {
                    location: new google.maps.LatLng(location.lat, location.lng),
                    radius: '50000',
                    query: retailer
                };

                service.textSearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                        // Calc distance to first result
                        const storeLoc = results[0].geometry.location;
                        const userLoc = new google.maps.LatLng(location.lat, location.lng);
                        const distanceInMeters = google.maps.geometry.spherical.computeDistanceBetween(userLoc, storeLoc);
                        const miles = (distanceInMeters * 0.000621371).toFixed(1);
                        setDist(miles);
                    }
                });
            }, [retailer, location]);

            if (!dist) return null;
            return <span className="text-xs font-bold text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded ml-2">üìç {dist} mi</span>;
        };

        const StoreLocator = ({ location }) => {
            const mapRef = useRef(null);

            useEffect(() => {
                if (!location || !mapRef.current || !window.google) return;
                const map = new google.maps.Map(mapRef.current, {
                    center: location,
                    zoom: 12,
                    disableDefaultUI: true
                });

                new google.maps.Marker({
                    position: location,
                    map: map,
                    title: "You are here",
                    icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                });

                // Find generic gift shops nearby
                const service = new google.maps.places.PlacesService(map);
                service.nearbySearch({
                    location: location,
                    radius: 5000,
                    type: ['department_store', 'shopping_mall']
                }, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        results.forEach(place => {
                            new google.maps.Marker({
                                position: place.geometry.location,
                                map: map,
                                title: place.name
                            });
                        });
                    }
                });

            }, [location]);

            return (
                <div className="bg-white p-4 rounded-xl shadow-lg border border-slate-100 mb-8">
                    <h3 className="text-lg font-bold text-slate-800 mb-2">üéÅ Local Shopping Map</h3>
                    <div ref={mapRef} className="w-full h-48 rounded-lg bg-slate-200"></div>
                </div>
            );
        };

        // --- EXISTING COMPONENTS ---
        const StarRating = ({ rating }) => {
            const r = parseFloat(rating) || 0;
            return (
                <div className="flex items-center text-yellow-400 gap-0.5">
                    {[1, 2, 3, 4, 5].map(i => (
                        <svg key={i} className={`w-4 h-4 ${i <= r ? 'fill-current' : 'text-gray-300'}`} viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" fill={i <= r ? "currentColor" : "none"} stroke="currentColor" />
                        </svg>
                    ))}
                </div>
            );
        };

        const ImageCarousel = ({ images, alt }) => {
            const [idx, setIdx] = useState(0);
            if (!images || images.length === 0) return <div className="h-56 bg-gray-100 flex items-center justify-center text-gray-400">No Image</div>;

            return (
                <div className="relative h-56 group overflow-hidden">
                    <img src={images[idx]} alt={alt} className="w-full h-full object-cover transition duration-500 transform group-hover:scale-105" />
                    {images.length > 1 && (
                        <>
                            <button onClick={() => setIdx(i => i > 0 ? i - 1 : images.length - 1)} className="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 p-1 rounded-full shadow hover:bg-white opacity-0 group-hover:opacity-100 transition">‚Üê</button>
                            <button onClick={() => setIdx(i => i < images.length - 1 ? i + 1 : 0)} className="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 p-1 rounded-full shadow hover:bg-white opacity-0 group-hover:opacity-100 transition">‚Üí</button>
                            <div className="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1">
                                {images.map((_, i) => <div key={i} className={`w-1.5 h-1.5 rounded-full ${i === idx ? 'bg-white' : 'bg-white/50'}`} />)}
                            </div>
                        </>
                    )}
                </div>
            );
        };

        function Spinner({ text }) {
            return (
                <div className="flex flex-col items-center justify-center p-12">
                    <div className="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
                    <p className="text-slate-500 font-medium animate-pulse">{text}</p>
                </div>
            );
        }

        function GiftCard({ gift, userLoc }) {
            return (
                <div className="bg-white rounded-xl shadow hover:shadow-xl transition duration-300 border border-slate-100 overflow-hidden flex flex-col h-full relative">
                    {gift.rating >= 4.5 && (
                        <div className="absolute top-3 left-3 z-10 bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1 shadow-sm">‚≠ê Highly Rated</div>
                    )}

                    <ImageCarousel images={gift.images} alt={gift.name} />

                    <div className="p-5 flex-1 flex flex-col">
                        <div className="flex justify-between items-start mb-1">
                            <span className="text-xs font-bold text-indigo-600 uppercase tracking-wide">{gift.category}</span>
                            {gift.rating && (
                                <div className="flex items-center gap-1">
                                    <StarRating rating={gift.rating} />
                                    <span className="text-xs text-slate-400">({gift.reviews_count})</span>
                                </div>
                            )}
                        </div>

                        <h3 className="text-lg font-bold text-slate-800 mb-2 leading-tight">{gift.name}</h3>
                        <p className="text-sm text-slate-600 mb-4 line-clamp-2">{gift.description}</p>

                        {gift.review_snippet && (
                            <div className="bg-slate-50 p-2 rounded text-xs text-slate-500 italic mb-4 border-l-2 border-yellow-400">"{gift.review_snippet}"</div>
                        )}

                        <div className="mt-auto space-y-2">
                            {gift.prices && gift.prices.length > 0 ? (
                                <div className="border border-indigo-100 bg-indigo-50/50 rounded-lg p-3">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="flex items-center">
                                            <span className="text-sm font-medium text-slate-700">{gift.prices[0].source}</span>
                                            {/* Distance Badge */}
                                            {userLoc && <DistanceBadge retailer={gift.prices[0].source} location={userLoc} />}
                                        </div>
                                        <span className="font-bold text-green-700 text-lg">{gift.prices[0].price}</span>
                                    </div>
                                    <div className="flex justify-between items-center text-xs text-slate-500 mb-2">
                                        <span>üöö {gift.prices[0].delivery}</span>
                                    </div>
                                    <a href={getAffiliateLink(gift.prices[0].link)} target="_blank" className="block w-full bg-indigo-600 text-white text-center py-2 rounded font-bold hover:bg-indigo-700 transition shadow-sm">Buy Now</a>

                                    {gift.prices.length > 1 && (
                                        <div className="mt-2 pt-2 border-t border-indigo-100">
                                            <p className="text-xs text-slate-400 mb-1">Also available from:</p>
                                            {gift.prices.slice(1).map((p, i) => (
                                                <div key={i} className="flex justify-between text-xs text-slate-600 py-0.5">
                                                    <div className="flex items-center">
                                                        <span>{p.source}</span>
                                                        {userLoc && i < 2 && <DistanceBadge retailer={p.source} location={userLoc} />}
                                                    </div>
                                                    <a href={getAffiliateLink(p.link)} target="_blank" className="hover:text-indigo-600 hover:underline">{p.price}</a>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="h-24 bg-slate-50 rounded animate-pulse flex items-center justify-center text-xs text-slate-400">Checking retailers...</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('');
            const [recs, setRecs] = useState([]);
            const [userLoc, setUserLoc] = useState(null);

            const [form, setForm] = useState({
                age: '28', gender: 'Female', relationship: 'Girlfriend', occasion: 'Birthday',
                interests: ['Yoga', 'Coffee', 'Reading'], hobbies: '',
                budgetMin: 50, budgetMax: 150
            });

            // Get Location on Mount
            useEffect(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => setUserLoc({ lat: position.coords.latitude, lng: position.coords.longitude }),
                        (err) => console.log("Loc Check: ", err)
                    );
                }
            }, []);

            const runSearch = async () => {
                setLoading(true);
                setStep(2);
                setStatus("Analyzing Trends & Recipient Profile...");

                try {
                    // Use production URL if handling cross-origin or just relative path if served from same origin
                    // In Vercel, relative path /api/... works.
                    const rRes = await fetch('/api/recommendations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(form)
                    });
                    const rData = await rRes.json();

                    if (rData.error) throw new Error(rData.error);
                    setRecs(rData.recommendations);

                    setStatus("Comparing Prices & Reading Reviews...");
                    const pRes = await fetch('/api/pricing', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: rData.recommendations })
                    });
                    const pData = await pRes.json();
                    setRecs(pData.results);
                } catch (e) {
                    console.error(e);
                    alert("Something went wrong. Showing cached results.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8">
                    <header className="flex flex-col md:flex-row md:justify-between md:items-center mb-8 gap-4">
                        <div>
                            <h1 className="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600 tracking-tight">GiftAI</h1>
                            <p className="text-sm text-slate-500 font-medium">Smart Recommendations & Price Tracking</p>
                        </div>
                        {step === 2 && <button onClick={() => setStep(1)} className="text-sm font-semibold text-slate-600 hover:text-indigo-600">‚Üê New Search</button>}
                    </header>

                    {step === 1 && (
                        <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-100 p-8">
                            <h2 className="text-2xl font-bold text-slate-800 mb-6">Find the Perfect Gift</h2>

                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <label className="block">
                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wide">Age</span>
                                    <input type="number" value={form.age} onChange={e => setForm({ ...form, age: e.target.value })} className="mt-1 block w-full rounded-lg border-slate-200 bg-slate-50 p-3 font-semibold focus:ring-2 focus:ring-indigo-500 outline-none transition" />
                                </label>
                                <label className="block">
                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wide">Gender</span>
                                    <select value={form.gender} onChange={e => setForm({ ...form, gender: e.target.value })} className="mt-1 block w-full rounded-lg border-slate-200 bg-slate-50 p-3 font-semibold focus:ring-2 focus:ring-indigo-500 outline-none transition">
                                        <option>Female</option><option>Male</option><option>Non-binary</option>
                                    </select>
                                </label>
                            </div>

                            <div className="mb-6">
                                <span className="text-xs font-bold text-slate-500 uppercase tracking-wide block mb-2">Interests</span>
                                <div className="flex flex-wrap gap-2">
                                    {['Yoga', 'Coffee', 'Reading', 'Gaming', 'Tech', 'Travel', 'Art', 'Fitness', 'Music'].map(tag => (
                                        <button key={tag} onClick={() => {
                                            const newInts = form.interests.includes(tag) ? form.interests.filter(i => i !== tag) : [...form.interests, tag];
                                            setForm({ ...form, interests: newInts });
                                        }} className={`px-4 py-2 rounded-full text-sm font-bold transition duration-200 ${form.interests.includes(tag) ? 'bg-indigo-600 text-white shadow-md transform scale-105' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                            {tag}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-slate-50 p-6 rounded-xl mb-6">
                                <h3 className="text-sm font-bold text-slate-700 mb-4">Budget Range</h3>
                                <div className="flex items-center gap-4">
                                    <div className="relative flex-1">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                                        <input type="number" value={form.budgetMin} onChange={e => setForm({ ...form, budgetMin: e.target.value })} className="w-full pl-6 p-2 rounded border border-slate-200 shadow-sm" />
                                    </div>
                                    <span className="text-slate-400 font-bold">-</span>
                                    <div className="relative flex-1">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                                        <input type="number" value={form.budgetMax} onChange={e => setForm({ ...form, budgetMax: e.target.value })} className="w-full pl-6 p-2 rounded border border-slate-200 shadow-sm" />
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-between items-center mb-4">
                                <button onClick={runSearch} className="w-full bg-indigo-600 text-white text-lg font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 hover:shadow-xl hover:-translate-y-0.5 transition duration-300">
                                    Find Gifts üéÅ
                                </button>
                            </div>
                            {userLoc && <div className="text-center text-xs text-green-600">üìç Location Active: Showing local availability</div>}
                        </div>
                    )}

                    {step === 2 && (
                        <div>
                            {loading && (!recs || recs.length === 0) ? (
                                <Spinner text={status} />
                            ) : (
                                <div className="animate-fade-in-up">
                                    {/* Store Locator Map at Top of Results */}
                                    {userLoc && <StoreLocator location={userLoc} />}

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        {recs.map((g, i) => <GiftCard key={i} gift={g} userLoc={userLoc} />)}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>